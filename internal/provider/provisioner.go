package provider

import (
	"context"
	"crypto/sha256"
	"encoding/base64"
	"encoding/hex"
	"fmt"
	"net/url"
	"strings"

	"github.com/oxidecomputer/oxide.go/oxide"
	"github.com/siderolabs/omni/client/pkg/constants"
	"github.com/siderolabs/omni/client/pkg/infra/provision"
	"github.com/siderolabs/omni/client/pkg/omni/resources/infra"
	"go.uber.org/zap"
)

var _ provision.Provisioner[*Instance] = (*Provisioner)(nil)

type Provisioner struct {
	oxideClient *oxide.Client
}

func NewProvisioner(oxideClient *oxide.Client) *Provisioner {
	return &Provisioner{
		oxideClient: oxideClient,
	}
}

func (p *Provisioner) ProvisionSteps() []provision.Step[*Instance] {
	return []provision.Step[*Instance]{
		provision.NewStep(
			"generate_schematic_id",
			func(ctx context.Context, logger *zap.Logger, pctx provision.Context[*Instance]) error {
				schematicID, err := pctx.GenerateSchematicID(ctx, logger,
					provision.WithExtraKernelArgs(
						"-console",
						"console=ttyS0",
					),
					provision.WithExtraExtensions(
						"siderolabs/amd-ucode",
						"siderolabs/iscsi-tools",
						"siderolabs/util-linux-tools",
					),
					// Connection parameters must not be present in kernel arguments since this
					// infrastructure provider uses NoCloud images and passes the SideroLink
					// configuration via cloud-init instead.
					provision.WithoutConnectionParams(),
				)
				if err != nil {
					return fmt.Errorf("failed generating schematic id: %w", err)
				}

				logger.Info("generated schematic id",
					zap.String("talos.schematic_id", schematicID),
				)

				pctx.State.TypedSpec().Value.TalosSchematicId = schematicID

				return nil
			},
		),
		provision.NewStep(
			"generate_talos_image_url",
			func(ctx context.Context, logger *zap.Logger, pctx provision.Context[*Instance]) error {
				imageURL, err := url.Parse(constants.ImageFactoryBaseURL)
				if err != nil {
					return fmt.Errorf("failed to parse image url: %w", err)
				}

				imageURL = imageURL.JoinPath(
					"image",
					pctx.State.TypedSpec().Value.TalosSchematicId,
					pctx.GetTalosVersion(),
					"nocloud-amd64.raw.xz",
				)

				logger.Info("generated talos image url",
					zap.String("talos.image_url", imageURL.String()),
				)

				pctx.State.TypedSpec().Value.TalosImageUrl = imageURL.String()

				return nil
			},
		),
		provision.NewStep(
			"generate_image_name",
			func(ctx context.Context, logger *zap.Logger, pctx provision.Context[*Instance]) error {
				talosImageUrl := pctx.State.TypedSpec().Value.TalosImageUrl

				hash := sha256.New()
				if _, err := hash.Write([]byte(talosImageUrl)); err != nil {
					return fmt.Errorf("failed to write to hash: %w", err)
				}
				schematicHash := hex.EncodeToString(hash.Sum(nil))[:8]

				imageName := fmt.Sprintf("talos-v%s-%s-nocloud-amd64",
					strings.ReplaceAll(pctx.GetTalosVersion(), ".", "-"),
					schematicHash,
				)

				logger.Info("generated image name",
					zap.String("oxide.image_name", imageName),
				)

				pctx.State.TypedSpec().Value.ImageName = imageName

				return nil
			},
		),
		provision.NewStep(
			"fetch_image_id",
			func(ctx context.Context, logger *zap.Logger, pctx provision.Context[*Instance]) error {
				pctx.State.TypedSpec().Value.ImageName = "talos-v1-11-3-728b61bf-nocloud-amd64"
				imageName := pctx.State.TypedSpec().Value.ImageName

				image, err := p.oxideClient.ImageView(ctx, oxide.ImageViewParams{
					Image:   oxide.NameOrId(imageName),
					Project: "matthewsanabria",
				})
				if err != nil {
					return fmt.Errorf("failed view image: %w", err)
				}

				logger.Info("fetch oxide image id",
					zap.String("oxide.image_id", image.Id),
				)

				pctx.State.TypedSpec().Value.ImageId = image.Id

				return nil
			},
		),
		// TODO: Handle image downloading and uploading.
		provision.NewStep(
			"instance_create",
			func(ctx context.Context, logger *zap.Logger, pctx provision.Context[*Instance]) error {
				instanceID := pctx.State.TypedSpec().Value.Id

				logger = logger.With(zap.String("omni.request_id", pctx.GetRequestID()))

				if instanceID != "" {
					logger.Info("confirming whether instance exists in oxide",
						zap.String("oxide.instance.id", instanceID),
					)

					instance, err := p.oxideClient.InstanceView(ctx, oxide.InstanceViewParams{
						Instance: oxide.NameOrId(instanceID),
					})
					if err != nil {
						return fmt.Errorf("failed viewing oxide instance: %w", err)
					}

					logger.Info("instance already exists",
						zap.String("oxide.instance.id", instanceID),
						zap.String("oxide.instance.run_state", string(instance.RunState)),
						zap.String("oxide.instance.name", string(instance.Name)),
					)

					return nil
				}

				params := oxide.InstanceCreateParams{
					Project: "matthewsanabria",
					Body: &oxide.InstanceCreate{
						AntiAffinityGroups: []oxide.NameOrId{},
						AutoRestartPolicy:  "",
						BootDisk: &oxide.InstanceDiskAttachment{
							Description: fmt.Sprintf("Managed by Oxide Omni infrastructure provider (%s).", pctx.GetRequestID()),
							DiskSource: oxide.DiskSource{
								BlockSize: 512,
								Type:      oxide.DiskSourceTypeImage,
								ImageId:   pctx.State.TypedSpec().Value.ImageId,
							},
							Name: oxide.Name(fmt.Sprintf("%s-boot-disk", pctx.GetRequestID())),
							Size: 53687091200,
							Type: oxide.InstanceDiskAttachmentTypeCreate,
						},
						Description: fmt.Sprintf("Managed by Oxide Omni infrastructure provider (%s).", pctx.GetRequestID()),
						Disks:       []oxide.InstanceDiskAttachment{},
						ExternalIps: []oxide.ExternalIpCreate{},
						Hostname:    oxide.Hostname(pctx.GetRequestID()),
						Memory:      17179869184,
						Name:        oxide.Name(pctx.GetRequestID()),
						Ncpus:       4,
						NetworkInterfaces: oxide.InstanceNetworkInterfaceAttachment{
							Params: []oxide.InstanceNetworkInterfaceCreate{
								{
									Description: fmt.Sprintf("Managed by Oxide Omni infrastructure provider (%s).", pctx.GetRequestID()),
									Name:        oxide.Name(fmt.Sprintf("%s-nic", pctx.GetRequestID())),
									SubnetName:  "default",
									VpcName:     "default",
								},
							},
							Type: oxide.InstanceNetworkInterfaceAttachmentTypeCreate,
						},
						SshPublicKeys: []oxide.NameOrId{},
						Start:         oxide.NewPointer(true),
						// TODO: Remove all the dots once https://github.com/siderolabs/talos/issues/11948 is released in v1.12.
						UserData:      base64.StdEncoding.EncodeToString(
							append(
								[]byte(pctx.ConnectionParams.JoinConfig),
								[]byte("\n\n#.............................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................................")...,
								),
						),
					},
				}

				instance, err := p.oxideClient.InstanceCreate(ctx, params)
				if err != nil {
					return fmt.Errorf("failed creating oxide instance: %w", err)
				}

				logger.Info("created instance",
					zap.String("oxide.instance.id", instance.Id),
					zap.String("oxide.instance.name", string(instance.Name)),
				)

				pctx.State.TypedSpec().Value.Id = instance.Id

				return nil
			},
		),
	}
}

func (p *Provisioner) Deprovision(
	ctx context.Context,
	logger *zap.Logger,
	resource *Instance,
	req *infra.MachineRequest,
) error {
	if resource == nil {
		return nil
	}

	if resource.TypedSpec() == nil {
		return nil
	}

	instanceID := resource.TypedSpec().Value.Id
	if instanceID == "" {
		logger.Info("no instance id found, skipping deprovision")
		return nil
	}

	instance, err := p.oxideClient.InstanceView(ctx, oxide.InstanceViewParams{
		Instance: oxide.NameOrId(instanceID),
	})
	if err != nil {
		if strings.Contains(err.Error(), "404") {
			logger.Info("instance not found, already deleted", zap.String("instance_id", instanceID))
			return nil
		}
		return fmt.Errorf("failed viewing oxide instance: %w", err)
	}

	bootDiskID := instance.BootDiskId
	logger.Info("retrieved instance details",
		zap.String("oxide.instance.id", instanceID),
		zap.String("oxide.instance.boot_disk_id", bootDiskID),
	)

	if err := p.oxideClient.InstanceDelete(ctx, oxide.InstanceDeleteParams{
		Instance: oxide.NameOrId(instanceID),
	}); err != nil {
		return fmt.Errorf("failed to delete oxide instance: %w", err)
	}

	logger.Info("deleted instance",
		zap.String("instance_id", instanceID),
	)

	if bootDiskID != "" {
		if err := p.oxideClient.DiskDelete(ctx, oxide.DiskDeleteParams{
			Disk: oxide.NameOrId(bootDiskID),
		}); err != nil {
			return fmt.Errorf("failed to delete boot disk: %w", err)
		}

		logger.Info("deleted boot disk", zap.String("boot_disk_id", bootDiskID))
	}

	return nil
}
